name: Android Release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ================= CHECKOUT =================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ================= FLUTTER =================
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'

      - name: Install dependencies
        run: flutter pub get

      # ================= RELEASE KEYSTORE =================
      - name: Setup Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > android/app/dirigenten-release.jks
          echo "Keystore erstellt: android/app/dirigenten-release.jks"

      # ================= BUILD =================
      - name: Build APK (release)
        run: |
          flutter build apk --release \
            --build-name=${{ steps.next_release.outputs.next_release }} \
            --build-number=$(date +%s)

      # ================= GET NEXT RELEASE NUMBER =================
      - name: Determine next release number
        id: next_release
        run: |
          FILES_XML=$(curl -s -u "${{ secrets.NC_USER }}:${{ secrets.NC_PASS }}" \
            -X PROPFIND \
            "https://cloud.notenserver.duckdns.org/remote.php/dav/files/mwesterh/releases/")

          VERSIONS=$(echo "$FILES_XML" | grep -oP 'dirigenten_application-\K(\d+\.\d+\.\d+)(?=\.apk)')

          if [ -z "$VERSIONS" ]; then
            NEXT="0.0.1"
          else
            LAST=$(echo "$VERSIONS" | sort -V | tail -n1)
            MAJOR=$(echo $LAST | cut -d. -f1)
            MINOR=$(echo $LAST | cut -d. -f2)
            PATCH=$(echo $LAST | cut -d. -f3)
            PATCH=$((PATCH+1))
            NEXT="$MAJOR.$MINOR.$PATCH"
          fi

          echo "next_release=$NEXT" >> $GITHUB_OUTPUT
          echo "Next release version: $NEXT"

      # ================= RENAME =================
      - name: Rename APK
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk \
          dirigenten_application-${{ steps.next_release.outputs.next_release }}.apk

      # ================= NEXTCLOUD =================
      - name: Ensure releases folder exists
        run: |
          curl -u "${{ secrets.NC_USER }}:${{ secrets.NC_PASS }}" \
               -X MKCOL \
               "https://cloud.notenserver.duckdns.org/remote.php/dav/files/mwesterh/releases" \
          || true

      - name: Upload APK to Nextcloud (WebDAV)
        run: |
          curl -u "${{ secrets.NC_USER }}:${{ secrets.NC_PASS }}" \
               -T dirigenten_application-${{ steps.next_release.outputs.next_release }}.apk \
               "https://cloud.notenserver.duckdns.org/remote.php/dav/files/mwesterh/releases/dirigenten_application-${{ steps.next_release.outputs.next_release }}.apk"

      # ================= WEBSOCAT INSTALL =================
      - name: Install websocat
        run: |
          wget -O websocat https://github.com/vi/websocat/releases/latest/download/websocat.x86_64-unknown-linux-musl
          chmod +x websocat
          sudo mv websocat /usr/local/bin/websocat

      # ================= NOTIFY NOTEN SERVER =================
      - name: Notify Noten Server (WebSocket)
        run: |
          echo -n '{"type":"release_announce","app":"dirigenten_application","version":"${{ steps.next_release.outputs.next_release }}","apkUrl":"https://cloud.notenserver.duckdns.org/remote.php/dav/files/mwesterh/releases/dirigenten_application-${{ steps.next_release.outputs.next_release }}.apk"}' \
          | websocat wss://ws.notenserver.duckdns.org
