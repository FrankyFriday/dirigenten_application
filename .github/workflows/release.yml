name: Android Release

on:
  workflow_dispatch: # Manuelles Triggern
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ================= CHECKOUT =================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ================= FLUTTER =================
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'

      - name: Install dependencies
        run: flutter pub get

      # ================= BUILD =================
      - name: Build APK (release)
        run: flutter build apk --release

      # ================= GET NEXT RELEASE NUMBER =================
      - name: Determine next release number
        id: next_release
        run: |
          # Liste der Dateien aus Nextcloud abrufen
          FILES=$(curl -s -u "${{ secrets.NC_USER }}:${{ secrets.NC_PASS }}" \
            "https://cloud.notenserver.duckdns.org/remote.php/dav/files/mwesterh/releases/")

          # Finde alle dirigenten_application-APKs und extrahiere Versionsnummern
          VERSIONS=$(echo "$FILES" | grep -oP 'dirigenten_application-(\d+\.\d+\.\d+)\.apk' | grep -oP '\d+\.\d+\.\d+')

          # Falls keine vorhanden, starte bei 0.0.1
          if [ -z "$VERSIONS" ]; then
            NEXT="0.0.1"
          else
            # Sortiere Versionen und erhÃ¶he die letzte Patch-Version
            LAST=$(echo "$VERSIONS" | sort -V | tail -n1)
            MAJOR=$(echo $LAST | cut -d. -f1)
            MINOR=$(echo $LAST | cut -d. -f2)
            PATCH=$(echo $LAST | cut -d. -f3)
            PATCH=$((PATCH+1))
            NEXT="$MAJOR.$MINOR.$PATCH"
          fi

          echo "next_release=$NEXT" >> $GITHUB_OUTPUT
          echo "Next release version: $NEXT"

      # ================= RENAME =================
      - name: Rename APK
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk \
          dirigenten_application-${{ steps.next_release.outputs.next_release }}.apk

      # ================= NEXTCLOUD =================
      - name: Ensure releases folder exists
        run: |
          curl -u "${{ secrets.NC_USER }}:${{ secrets.NC_PASS }}" \
               -X MKCOL \
               "https://cloud.notenserver.duckdns.org/remote.php/dav/files/mwesterh/releases" \
          || true

      - name: Upload APK to Nextcloud (WebDAV)
        run: |
          curl -u "${{ secrets.NC_USER }}:${{ secrets.NC_PASS }}" \
               -T dirigenten_application-${{ steps.next_release.outputs.next_release }}.apk \
               "https://cloud.notenserver.duckdns.org/remote.php/dav/files/mwesterh/releases/dirigenten_application-${{ steps.next_release.outputs.next_release }}.apk"

      # ================= WEBSOCAT INSTALL =================
      - name: Install websocat
        run: |
          wget -O websocat https://github.com/vi/websocat/releases/latest/download/websocat.x86_64-unknown-linux-musl
          chmod +x websocat
          sudo mv websocat /usr/local/bin/websocat

      # ================= NOTIFY NOTEN SERVER =================
      - name: Notify Noten Server (WebSocket)
        run: |
          echo '{
            "type": "release_announce",
            "app": "dirigenten_application",
            "version": "${{ steps.next_release.outputs.next_release }}",
            "apkUrl": "https://cloud.notenserver.duckdns.org/s/EjyiF5P2K76kHsC/dirigenten_application-${{ steps.next_release.outputs.next_release }}.apk"
          }' | websocat wss://ws.notenserver.duckdns.org
