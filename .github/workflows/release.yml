name: Android Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ================= CHECKOUT =================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ================= FLUTTER =================
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'

      - name: Install dependencies
        run: flutter pub get

      # ================= BUILD =================
      - name: Build APK (release)
        run: flutter build apk --release

      # ================= VERSION =================
      - name: Read app version
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # ================= RENAME =================
      - name: Rename APK
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk \
          dirigenten_application-${{ steps.version.outputs.version }}.apk

      # ================= NEXTCLOUD =================
      - name: Ensure releases folder exists
        run: |
          curl -u "${{ secrets.NC_USER }}:${{ secrets.NC_PASS }}" \
               -X MKCOL \
               "https://cloud.notenserver.duckdns.org/remote.php/dav/files/mwesterh/releases" \
          || true

      - name: Upload APK to Nextcloud (WebDAV)
        run: |
          curl -u "${{ secrets.NC_USER }}:${{ secrets.NC_PASS }}" \
               -T dirigenten_application-${{ steps.version.outputs.version }}.apk \
               "https://cloud.notenserver.duckdns.org/remote.php/dav/files/mwesterh/releases/dirigenten_application-${{ steps.version.outputs.version }}.apk"

      # ================= WEBSOCAT INSTALL =================
      - name: Install websocat
        run: |
          wget https://github.com/vi/websocat/releases/download/v1.13.0/websocat_amd64-linux -O /usr/local/bin/websocat
          chmod +x /usr/local/bin/websocat

      # ================= NOTIFY NOTEN SERVER =================
      - name: Notify Noten Server (WebSocket)
        run: |
          echo '{
            "type": "release_announce",
            "app": "dirigenten_application",
            "version": "${{ steps.version.outputs.version }}",
            "apkUrl": "https://cloud.notenserver.duckdns.org/s/EjyiF5P2K76kHsC/dirigenten_application-${{ steps.version.outputs.version }}.apk"
          }' | websocat ws://ws.notenserver.duckdns.org
